{% extends 'layout.html' %}
{% block body %}

{# ---------------------------------------
  Helpers / √©tat UI
---------------------------------------- #}
{% set sec = selected_secteur if selected_secteur else sectors[0] %}
{% set s = summary.get(sec, {}) %}
{% set active_tab = request.args.get('tab', 'overview') %}

<style>
  /* ---- Passeport UX ---- */
  .passport-header h1 { margin: 0; }
  .passport-sub { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px; }
  .passport-tabs { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .tabbtn { border:1px solid #ddd; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; }
  .tabbtn.active { border-color:#333; font-weight:600; }
  .tabpanel { display:none; }
  .tabpanel.active { display:block; }

  .kpi-grid { display:grid; grid-template-columns:repeat(5,minmax(140px,1fr)); gap:10px; }
  @media (max-width: 1100px){ .kpi-grid{ grid-template-columns:repeat(2,minmax(160px,1fr)); } }
  .kpi { border:1px solid #eee; border-radius:12px; padding:10px; background:#fff; }
  .kpi .muted { font-size:12px; }
  .kpi strong { font-size:20px; display:block; margin-top:2px; }

  .progressbar { height:10px; background:#eee; border-radius:999px; overflow:hidden; }
  .progressbar > div { height:100%; background:#222; width:0%; }

  .pillrow { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
  .pill { border-radius:999px; padding:6px 10px; border:1px solid #ddd; font-size:12px; display:inline-flex; gap:6px; align-items:center; }
  .pill b { font-size:12px; }
  .lvl0 { background:#fff; }
  .lvl1 { background:#fff4e5; border-color:#f1c48b; }
  .lvl2 { background:#e9f8ee; border-color:#92d6a3; }
  .lvl3 { background:#daf2df; border-color:#5dbf78; font-weight:600; }

  .ref-card { border:1px solid #eee; border-radius:14px; padding:12px; margin-bottom:10px; }
  .ref-head { display:flex; justify-content:space-between; align-items:end; gap:10px; flex-wrap:wrap; }
  .ref-title { margin:0; font-size:16px; }
  .ref-meta { font-size:12px; color:#666; }

  .split { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width: 1100px){ .split{ grid-template-columns:1fr; } }

  .note-item { border:1px solid #eee; border-radius:12px; padding:10px; margin-bottom:8px; }
  .note-top { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .note-cat { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #ddd; background:#fff; }
  .note-date { font-size:12px; color:#666; }
  .note-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }

  .file-card { border:1px solid #eee; border-radius:12px; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center; }
  .file-meta { font-size:12px; color:#666; }
</style>

<div class="stack">

  <div class="card passport-header">
    <h1>Passeport habitant ¬∑ {{ participant.nom }} {{ participant.prenom }}</h1>

    <div class="passport-sub">
      <a class="btn" href="{{ url_for('activite.index') }}">‚Üê Retour √©margement</a>

      <div class="row" style="gap:8px;flex-wrap:wrap;">
        {% for sector in sectors %}
          <a class="btn {% if sector == sec %}ok{% endif %}"
             href="{{ url_for('pedagogie.participant_passeport', participant_id=participant.id, secteur=sector, tab=active_tab) }}">
            {{ sector }}
          </a>
        {% endfor %}
      </div>
    </div>

    <div class="passport-tabs" id="passportTabs">
      <button class="tabbtn" data-tab="overview">Vue d‚Äôensemble</button>
      <button class="tabbtn" data-tab="evaluate">√âvaluer</button>
      <button class="tabbtn" data-tab="skills">Comp√©tences</button>
      <button class="tabbtn" data-tab="notes">Notes</button>
      <button class="tabbtn" data-tab="files">Documents</button>
    </div>
  </div>

  {# -----------------------------
     TAB: OVERVIEW
  ------------------------------ #}
  <div class="card tabpanel" data-panel="overview">
    <h2 style="margin-top:0;">üìå R√©sum√© ({{ sec }})</h2>

    <div class="kpi-grid">
      <div class="kpi">
        <div class="muted">Nb sessions</div>
        <strong>{{ s.nb_sessions or 0 }}</strong>
      </div>
      <div class="kpi">
        <div class="muted">Derni√®re participation</div>
        <strong>{{ s.last_participation or '‚Äî' }}</strong>
      </div>
      <div class="kpi">
        <div class="muted">Notes</div>
        <strong>{{ s.nb_notes or 0 }}</strong>
      </div>
      <div class="kpi">
        <div class="muted">Comp√©tences valid√©es</div>
        <strong>{{ s.nb_competences_validees or 0 }}</strong>
      </div>
      <div class="kpi">
        <div class="muted">Intensit√©</div>
        <strong>{{ s.intensity or 0 }}/mois</strong>
        {# Barre indicative simple (0‚Äì30) #}
        {% set intensity_pct = ((s.intensity or 0) / 30.0 * 100.0) %}
        {% if intensity_pct < 0 %}{% set intensity_pct = 0 %}{% endif %}
        {% if intensity_pct > 100 %}{% set intensity_pct = 100 %}{% endif %}
        <div class="progressbar" style="margin-top:6px;">
          <div style="width:{{ intensity_pct }}%;"></div>
        </div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="split">
      <div class="ref-card">
        <div class="ref-head">
          <h3 class="ref-title">üß† Comp√©tences (aper√ßu)</h3>
          <div class="ref-meta">Validation = niveau ‚â• 2</div>
        </div>
        <div class="spacer"></div>
        <ul style="margin:0;">
          {% for ref,stats in referentiel_stats.items() %}
            <li style="margin-bottom:8px;">
              <div class="row" style="justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <span><strong>{{ ref }}</strong></span>
                <span class="muted">{{ stats.valides }}/{{ stats.total }} valid√©es</span>
              </div>
              {% set pct = (stats.valides / stats.total * 100) if stats.total else 0 %}
              <div class="progressbar" style="margin-top:6px;">
                <div style="width:{{ pct }}%;"></div>
              </div>
            </li>
          {% else %}
            <li class="muted">Aucune √©valuation.</li>
          {% endfor %}
        </ul>
      </div>

      <div class="ref-card">
        <div class="ref-head">
          <h3 class="ref-title">üóíÔ∏è Derni√®res notes</h3>
          <div class="ref-meta">Secteur : {{ sec }}</div>
        </div>
        <div class="spacer"></div>
        {% for n in notes[:5] %}
          <div class="note-item">
            <div class="note-top">
              <div class="note-date">{{ n.created_at.date() if n.created_at else '' }}</div>
              <div class="note-cat">{{ note_categories.get(n.categorie, n.categorie) }}</div>
            </div>
            <div style="margin-top:6px;">{{ n.contenu }}</div>
          </div>
        {% else %}
          <div class="muted">Aucune note.</div>
        {% endfor %}
        <div class="spacer"></div>
        <button class="btn" type="button" data-tablink="notes">Voir toutes les notes</button>
      </div>
    </div>
  </div>

  {# -----------------------------
     TAB: EVALUATE
  ------------------------------ #}
  <div class="card tabpanel" data-panel="evaluate">
    <h2 style="margin-top:0;">‚úÖ √âvaluer (hors session ou rattach√©e)</h2>
    <div class="muted" style="margin-top:-6px;">
      Astuce : rattache une session si tu veux retrouver l‚Äô√©valuation dans l‚Äôhistorique ‚Äúcomme si‚Äù.
    </div>
    <div class="spacer"></div>

    {# Ton form partial actuel #}
    {% include "pedagogie/_passeport_eval_form.html" %}

    <div class="spacer"></div>
    <div class="ref-card">
      <h3 class="ref-title" style="margin:0;">üìú Historique rapide</h3>
      <div class="tablewrap" style="margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Comp√©tence</th><th>√âtat</th><th>Commentaire</th><th>Session</th>
            </tr>
          </thead>
          <tbody>
            {% for e in events[:20] %}
              <tr>
                <td>{{ e.date_evaluation }}</td>
                <td>{{ e.competence.code }} ¬∑ {{ e.competence.nom }}</td>
                <td>{{ e.etat }}</td>
                <td>{{ e.commentaire or '' }}</td>
                <td>{{ e.session_id or '‚Äî' }}</td>
              </tr>
            {% else %}
              <tr><td colspan="5" class="muted">Aucune donn√©e.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px;">(Affichage limit√© aux 20 derni√®res entr√©es ici.)</div>
    </div>
  </div>

  {# -----------------------------
     TAB: SKILLS (graphique)
  ------------------------------ #}
  <div class="card tabpanel" data-panel="skills">
    <h2 style="margin-top:0;">üß© Comp√©tences (visuel)</h2>

    {# Groupement des comp√©tences par r√©f√©rentiel √† partir de current_levels + comp_map #}
    {% set by_ref = namespace(data={}) %}
    {% for cid, lvl in current_levels.items() %}
      {% set c = comp_map.get(cid) %}
      {% if c %}
        {% set rname = c.referentiel.nom if c.referentiel else "Sans r√©f√©rentiel" %}
        {% if rname not in by_ref.data %}
          {% set _ = by_ref.data.update({rname: []}) %}
        {% endif %}
        {% set _ = by_ref.data[rname].append((c, lvl)) %}
      {% endif %}
    {% endfor %}

    {% for ref, items in by_ref.data.items() %}
      {# stats #}
      <!-- {% set total = items|length %}
      {% set valides = (items | selectattr(1, 'ge', 2) | list) | length %}
      {% set pct = (valides / total * 100) if total else 0 %} -->
	  {% set total = items|length %}
	  {% set valides = namespace(n=0) %}
	  {% for pair in items %}
	    {% set c = pair[0] %}
	    {% set lvl = pair[1] %}
	    {% if lvl >= 2 %}
		  {% set valides.n = valides.n + 1 %}
	    {% endif %}
	  {% endfor %}
	  {% set pct = (valides.n / total * 100) if total else 0 %}
	
      <div class="ref-card">
        <div class="ref-head">
          <h3 class="ref-title">{{ ref }}</h3>
          <div class="ref-meta">{{ valides.n }}/{{ total }} valid√©es</div>
        </div>

        <div class="progressbar" style="margin-top:8px;">
          <div style="width:{{ pct }}%;"></div>
        </div>

        <div class="pillrow">
          {% for c,lvl in items %}
            {% set cls = "lvl0" %}
            {% if lvl == 1 %}{% set cls="lvl1" %}{% endif %}
            {% if lvl == 2 %}{% set cls="lvl2" %}{% endif %}
            {% if lvl >= 3 %}{% set cls="lvl3" %}{% endif %}
            <span class="pill {{ cls }}" title="{{ c.nom }}">
              <b>{{ c.code }}</b>
              <span class="muted">N{{ lvl }}</span>
            </span>
          {% endfor %}
        </div>

        <div class="muted" style="margin-top:10px;">
          L√©gende : N0 = non √©valu√©/√† faire ¬∑ N1 = en cours ¬∑ N2 = acquis ¬∑ N3 = ma√Ætris√©
        </div>
      </div>
    {% else %}
      <div class="muted">Aucune comp√©tence √©valu√©e pour l‚Äôinstant.</div>
    {% endfor %}

    <div class="spacer"></div>

    <details>
      <summary class="btn">Afficher le tableau complet (brut)</summary>
      <div class="spacer"></div>
      <div class="tablewrap">
        <table>
          <thead><tr><th>Date</th><th>Comp√©tence</th><th>√âtat</th><th>Commentaire</th><th>Session</th></tr></thead>
          <tbody>
            {% for e in events %}
              <tr>
                <td>{{ e.date_evaluation }}</td>
                <td>{{ e.competence.code }} ¬∑ {{ e.competence.nom }}</td>
                <td>{{ e.etat }}</td>
                <td>{{ e.commentaire or '' }}</td>
                <td>{{ e.session_id or '‚Äî' }}</td>
              </tr>
            {% else %}
              <tr><td colspan="5" class="muted">Aucune donn√©e.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </details>
  </div>

  {# -----------------------------
     TAB: NOTES
  ------------------------------ #}
  <div class="card tabpanel" data-panel="notes">
    <h2 style="margin-top:0;">üóíÔ∏è Notes / Journal ({{ sec }})</h2>

    <div class="split">
      <div class="ref-card">
        <h3 class="ref-title" style="margin:0;">Ajouter une note</h3>
        <div class="spacer"></div>

        <form method="post" action="{{ url_for('pedagogie.participant_passeport_note', participant_id=participant.id) }}?tab=notes">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="secteur" value="{{ sec }}">

          <label>Note</label>
          <textarea class="in" name="contenu" rows="3" required placeholder="Observation, progression, t√©moignage..."></textarea>

          <div class="spacer"></div>

          <label>Cat√©gorie</label>
          <select class="in" name="categorie">
            {% for cat, label in note_categories.items() %}
              <option value="{{ cat }}">{{ label }}</option>
            {% endfor %}
          </select>

          <div class="spacer"></div>
          <button class="btn ok" type="submit">Enregistrer</button>
        </form>

        <div class="spacer"></div>

        <form method="get" class="row" style="gap:8px;align-items:end;">
          <input type="hidden" name="secteur" value="{{ sec }}">
          <input type="hidden" name="tab" value="notes">
          <div>
            <label>Filtre cat√©gorie</label>
            <select class="in" name="categorie">
              <option value="">Toutes</option>
              {% for cat,nb in notes_by_cat.items() %}
                <option value="{{ cat }}" {% if selected_categorie==cat %}selected{% endif %}>
                  {{ note_categories.get(cat, cat) }} ({{ nb }})
                </option>
              {% endfor %}
            </select>
          </div>
          <button class="btn" type="submit">Filtrer</button>
        </form>
      </div>

      <div class="ref-card">
        <h3 class="ref-title" style="margin:0;">Historique</h3>
        <div class="spacer"></div>

        {% for n in notes %}
          <div class="note-item">
            <div class="note-top">
              <div class="note-date">{{ n.created_at.date() if n.created_at else '' }}</div>
              <div class="note-cat">{{ note_categories.get(n.categorie, n.categorie) }}</div>
            </div>

            <div style="margin-top:6px;">{{ n.contenu }}</div>

            <div class="note-actions">
              <form method="post"
                    action="{{ url_for('pedagogie.participant_passeport_note_update', participant_id=participant.id, note_id=n.id) }}?tab=notes">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row" style="gap:8px;flex-wrap:wrap;">
                  <select class="in" name="categorie" style="max-width:190px;">
                    {% for cat, label in note_categories.items() %}
                      <option value="{{ cat }}" {% if n.categorie==cat %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                  <input class="in" name="contenu" value="{{ n.contenu }}">
                  <button class="btn" type="submit">Mettre √† jour</button>
                </div>
              </form>

              <form method="post"
                    action="{{ url_for('pedagogie.participant_passeport_note_delete', participant_id=participant.id, note_id=n.id) }}?tab=notes"
                    onsubmit="return confirm('Supprimer cette note ?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn" type="submit">Supprimer</button>
              </form>
            </div>
          </div>
        {% else %}
          <div class="muted">Aucune note.</div>
        {% endfor %}

        {% if notes_total > page_size %}
          <div class="row" style="gap:8px; flex-wrap:wrap;">
            {% if notes_page > 1 %}
              <a class="btn" href="{{ url_for('pedagogie.participant_passeport', participant_id=participant.id, secteur=sec, tab='notes', categorie=selected_categorie, notes_page=notes_page-1, files_page=files_page) }}">‚Üê Notes pr√©c√©dentes</a>
            {% endif %}
            {% if notes_page * page_size < notes_total %}
              <a class="btn" href="{{ url_for('pedagogie.participant_passeport', participant_id=participant.id, secteur=sec, tab='notes', categorie=selected_categorie, notes_page=notes_page+1, files_page=files_page) }}">Notes suivantes ‚Üí</a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  {# -----------------------------
     TAB: FILES
  ------------------------------ #}
  <div class="card tabpanel" data-panel="files">
    <h2 style="margin-top:0;">üìé Documents ({{ sec }})</h2>

    <div class="split">
      <div class="ref-card">
        <h3 class="ref-title" style="margin:0;">Ajouter un document</h3>
        <div class="spacer"></div>

        <form method="post" action="{{ url_for('pedagogie.participant_passeport_file_upload', participant_id=participant.id) }}?tab=files" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="secteur" value="{{ sec }}">

          <label>Titre (optionnel)</label>
          <input class="in" name="titre" placeholder="Ex : Attestation, photo, CV, ...">

          <div class="spacer"></div>

          <label>Cat√©gorie</label>
          <select class="in" name="categorie">
            <option value="atelier">Atelier</option>
            <option value="temoignage">T√©moignage</option>
          </select>

          <div class="spacer"></div>

          <label>Fichier</label>
          <input class="in" type="file" name="file" required>

          <div class="spacer"></div>
          <button class="btn ok" type="submit">Uploader</button>
        </form>
      </div>

      <div class="ref-card">
        <h3 class="ref-title" style="margin:0;">Liste</h3>
        <div class="spacer"></div>

        {% for f in files %}
          <div class="file-card">
            <div>
              <div><strong>{{ f.titre or f.original_name }}</strong></div>
              <div class="file-meta">
                {{ f.categorie or '' }} ¬∑ {{ f.mime_type or '' }} ¬∑ {{ f.created_at.date() if f.created_at else '' }}
              </div>
            </div>
            <div>
              <a class="btn ok" href="{{ url_for('pedagogie.participant_passeport_file_download', participant_id=participant.id, file_id=f.id) }}">T√©l√©charger</a>
            </div>
          </div>
        {% else %}
          <div class="muted">Aucune pi√®ce jointe.</div>
        {% endfor %}

        {% if files_total > page_size %}
          <div class="row" style="gap:8px; flex-wrap:wrap;">
            {% if files_page > 1 %}
              <a class="btn" href="{{ url_for('pedagogie.participant_passeport', participant_id=participant.id, secteur=sec, tab='files', categorie=selected_categorie, notes_page=notes_page, files_page=files_page-1) }}">‚Üê Fichiers pr√©c√©dents</a>
            {% endif %}
            {% if files_page * page_size < files_total %}
              <a class="btn" href="{{ url_for('pedagogie.participant_passeport', participant_id=participant.id, secteur=sec, tab='files', categorie=selected_categorie, notes_page=notes_page, files_page=files_page+1) }}">Fichiers suivants ‚Üí</a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

<script>
  (function(){
    const tabs = document.querySelectorAll('#passportTabs .tabbtn');
    const panels = document.querySelectorAll('.tabpanel');

    function setActive(tab){
      tabs.forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
      panels.forEach(p => p.classList.toggle('active', p.dataset.panel === tab));
    }

    // tab depuis l'URL (fallback overview)
    const url = new URL(window.location.href);
    const tabFromUrl = url.searchParams.get('tab') || "{{ active_tab }}";
    setActive(tabFromUrl);

    // clic onglets => update URL ?tab=xxx sans reload + switch
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        url.searchParams.set('tab', btn.dataset.tab);
        window.history.replaceState({}, '', url.toString());
        setActive(btn.dataset.tab);
      });
    });

    // boutons internes data-tablink
    document.querySelectorAll('[data-tablink]').forEach(el => {
      el.addEventListener('click', () => {
        const t = el.getAttribute('data-tablink');
        url.searchParams.set('tab', t);
        window.history.replaceState({}, '', url.toString());
        setActive(t);
        window.scrollTo({top: 0, behavior: 'smooth'});
      });
    });
  })();
</script>

{% endblock %}